global
    maxconn 2048
    debug
    # Recommended SSL ciphers as per https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
    ssl-default-bind-options no-sslv3
    ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

    ssl-default-server-options no-sslv3
    ssl-default-server-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    tune.ssl.default-dh-param 2048

defaults
    mode http
    compression algo gzip
    compression type text/html text/plain text/css
    option forwardfor
    option http-server-close
    option http-buffer-request
    option nolinger
	option httpclose
	option abortonclose
    timeout http-request 7s
    timeout queue 10s
    timeout connect 5000ms
    timeout client 5000ms
    timeout server 5000ms
	retries 2

### HTTP(S) frontend ###
frontend www
    bind *:80

    

    reqadd X-Forwarded-Proto:\ http if !{ ssl_fc }
    reqadd X-Forwarded-Proto:\ https if { ssl_fc }
    

    # Generated automatically by consul-template

    acl host_consul hdr_beg(host) -i consul.haproxy.service.consul
    use_backend consul_backend if host_consul

    acl host_consul-53 hdr_beg(host) -i consul-53.haproxy.service.consul
    use_backend consul-53_backend if host_consul-53

    acl host_consul-8300 hdr_beg(host) -i consul-8300.haproxy.service.consul
    use_backend consul-8300_backend if host_consul-8300

    acl host_consul-8301 hdr_beg(host) -i consul-8301.haproxy.service.consul
    use_backend consul-8301_backend if host_consul-8301

    acl host_consul-8302 hdr_beg(host) -i consul-8302.haproxy.service.consul
    use_backend consul-8302_backend if host_consul-8302

    acl host_consul-8400 hdr_beg(host) -i consul-8400.haproxy.service.consul
    use_backend consul-8400_backend if host_consul-8400

    acl host_consul-8500 hdr_beg(host) -i consul-8500.haproxy.service.consul
    use_backend consul-8500_backend if host_consul-8500

    acl host_consul-8600 hdr_beg(host) -i consul-8600.haproxy.service.consul
    use_backend consul-8600_backend if host_consul-8600





### Consul-configured backend services ###

backend consul_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8300 192.168.15.11:8300

backend consul-53_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8600 192.168.15.11:8600

backend consul-8300_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8300 192.168.15.11:8300

backend consul-8301_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8301 192.168.15.11:8301
   server local-8301 192.168.15.11:8301

backend consul-8302_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8302 192.168.15.11:8302
   server local-8302 192.168.15.11:8302

backend consul-8400_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8400 192.168.15.11:8400

backend consul-8500_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8500 192.168.15.11:8500

backend consul-8600_backend
  # Detect an ApacheKiller-like Attack
  acl weirdrangehdr hdr_cnt(Range) gt 10
  # Clean up the request
  reqidel ^Range if weirdrangehdr
  # Setup stick table
  stick-table type ip size 1k expire 30s store gpc0
  # Configure the DoS src
  acl MARKED src_get_gpc0(ft_http) gt 0
  # tarpit attackers if src_DoS
  use_backend bk_tarpit if MARKED
  # If not blocked, track the connection
  tcp-request connection track-sc1 src if ! MARKED


   server local-8600 192.168.15.11:8600



